<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" href="" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>VirtualClap</title>
  </head>
  <style type="text/css">
    body {
      text-align: center;
      background-color: #26b72b;
    }
  </style>
  <body>
    <noscript>You need to enable JavaScript to run this app.</noscript>    
    <script>

      class VirtualClap {
        constructor() {
          this.configuration = {
            initialState: "STOP",
            STOP: {
              transitions: {
                CLICK: {
                  target: 'SEND_SOUND',
                  action: () => {
                    setTimeout(onTimer, 1000);
                  }
                }
              }
            },
            SEND_SOUND : {
              transitions: {
                TIMEOUT: {
                  target: 'WAIT_ACK',
                  action: () => {
                    beep();
                    console.log("SOUND");
                    this.timestampOfSound = getTimestamp();
                  }
                }
              }
            },
            WAIT_ACK : {
              transitions: {
                CLICK: {
                  target: 'RESULT',
                  action: () => {
                    const delta = getTimestamp() - this.timestampOfSound;
                    setResult(delta);
                  }
                }
              }
            },
            RESULT : {
              transitions: {
                CLICK: {
                  target: 'STOP',
                  action: () => {
                  }
                }
              }
            }
          }

          this.currentState = this.configuration.initialState;
          this.timestampOfSound = 0;
        }

        sendEvent(event) {
          const transition = this.configuration[this.currentState].transitions[event];
          if (transition) {
            transition.action();
            this.currentState = transition.target;
          }
        }

      }

      const virtualClap = new VirtualClap();
      
      function beep(){
        const audioCtx = new AudioContext()
        const vol = 100;
        const freq = 520;
        const duration = 200;
        const v = audioCtx.createOscillator()
        const u = audioCtx.createGain()
        v.connect(u)
        v.frequency.value = freq
        v.type = "square"
        u.connect(audioCtx.destination)
        u.gain.value = vol * 0.01
        v.start(audioCtx.currentTime)
        v.stop(audioCtx.currentTime + duration * 0.001)
      }

      function main() {
        console.log("MAIN");
      }

      function clickOnButton() {
        virtualClap.sendEvent("CLICK");
      }

      function onTimer() {
        virtualClap.sendEvent("TIMEOUT");
      }

      function getTimestamp() {
        return new Date().getTime(); 
      }

      function setResult(delta) {
        console.log(delta);
      }

      window.onload = function() {
        main();
      }
    </script>
    <h1>VirtualClap</h1>
    <input type="image" src="https://picsum.photos/200" onmousedown="clickOnButton()"/>
    <aside>Instruction du gwak</aside>
    <span>RÃ©sultat</span>
  </body>
</html>